<!DOCTYPE HTML>
<html>

<head><meta name="generator" content="Hexo 3.8.0">
	<link rel="bookmark" type="image/x-icon" href="/img/logo.png">
	<link rel="shortcut icon" href="/img/logo.png">
	
			    <title>
    Loren2o's Blog
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="/css/mic_main.css">
    <link rel="stylesheet" href="/css/dropdownMenu.css">
    <meta name="keywords" content="Loren2o">
    
    	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css">
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
</head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css">
<link rel="stylesheet" href="/css/typo.css">
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">Loren2o</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
            <ul class="menu links">
			<!-- Homepage  主页  --> 
			<li>
	            <a href="/" rel="nofollow">home</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">categories</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/Django/">Django</a>
	                    </li></ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/tag/" title="tag">
		                tag
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/lor3n2o" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
                    <li>
                        <a title="500px" href="http://500px.com" target="_blank" rel="noopener">
                            <i class="icon fa fa-500px"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main">
            <div class="post_page_title_img" style="height: 25rem;background-image: url(https://drscdn.500px.org/photo/186489967/q%3D80_m%3D2000/v2?webp=true&amp;sig=6db050329a4b1bd66ec0ce395597bf6ac8a99ec27f5ffebc35a269be20ce45d6);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;">
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2>Cookie和Session</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><h4 id="Cookie的由来"><a href="#Cookie的由来" class="headerlink" title="Cookie的由来"></a>Cookie的由来</h4><p>由于http协议每次请求都是独立的，对服务器来说的，每次请求的是全新的，状态可以理解为客户端和服务器在某次绘画中产生的数据，那无状态可以理解为数据不被保留，会话中的数据有事我们需要保存的，也就是说要保存状态，因此cookie在这样的一个场景下产生了。</p>
<h4 id="Cookie是什么"><a href="#Cookie是什么" class="headerlink" title="Cookie是什么"></a>Cookie是什么</h4><p>Cookie具体指的是一段小信息，他是服务器发送出来储存在浏览器上的一对对键值对，下次访问浏览器会自动鞋带这些键值对，以便服务器提取有用的信息。</p>
<h4 id="cookie的原理"><a href="#cookie的原理" class="headerlink" title="cookie的原理"></a>cookie的原理</h4><p>cookie的工作原理是：由服务器产生内容，浏览器收到请求后保存在本地，当浏览器再次访问时，浏览器会自动带上Cookie，这样服务器就能通过Cookie的内容来判断这个是“谁”发来的请求了。</p>
<h4 id="查看Cookie"><a href="#查看Cookie" class="headerlink" title="查看Cookie"></a>查看Cookie</h4><p>我们使用Chrome浏览器，打开开发者工具。<br><img src="/2018/12/16/Cookie和Session/1.png" alt=""></p>
<h3 id="Django中操作Cookie"><a href="#Django中操作Cookie" class="headerlink" title="Django中操作Cookie"></a>Django中操作Cookie</h3><h4 id="获取Cookie"><a href="#获取Cookie" class="headerlink" title="获取Cookie"></a>获取Cookie</h4><pre><code>request.COOKIES[&apos;key&apos;]
request.get_signed_cookie(&apos;key&apos;, default=RAISE_ERROR, salt=&apos;&apos;, max_age=None)
</code></pre><p>get_signed_cookie方法的参数：</p>
<ul>
<li>default: 默认值</li>
<li>salt: 加密盐</li>
<li>max_age: 后台控制过期时间</li>
</ul>
<h4 id="设置Cookie"><a href="#设置Cookie" class="headerlink" title="设置Cookie"></a>设置Cookie</h4><pre><code>rep = HttpResponse(...)
rep ＝ render(request, ...)

rep.set_cookie(key,value,...)
rep.set_signed_cookie(key,value,salt=&apos;加密盐&apos;,...)
</code></pre><p>参数：</p>
<ul>
<li>key, 键</li>
<li>value=’’, 值</li>
<li>max_age=None, 超时时间</li>
<li>expires=None, 超时时间(IE requires expires, so set it if hasn’t been already.)</li>
<li>path=’/‘, Cookie生效的路径，/ 表示根路径，特殊的：根路径的cookie可以被任何url的页面访问</li>
<li>domain=None, Cookie生效的域名</li>
<li>secure=False, https传输</li>
<li>httponly=False 只能http协议传输，无法被JavaScript获取（不是绝对，底层抓包可以获取到也可以被覆盖）</li>
</ul>
<h4 id="删除Cookie"><a href="#删除Cookie" class="headerlink" title="删除Cookie"></a>删除Cookie</h4><pre><code>def logout(request):
    rep = redirect(&quot;/login/&quot;)
    rep.delete_cookie(&quot;user&quot;)  # 删除用户浏览器上之前设置的user的cookie值
    return rep
</code></pre><h4 id="Cookie版登陆校验"><a href="#Cookie版登陆校验" class="headerlink" title="Cookie版登陆校验"></a>Cookie版登陆校验</h4><pre><code>def check_login(func):
    @wraps(func)
    def inner(request, *args, **kwargs):
        next_url = request.get_full_path()
        if request.get_signed_cookie(&quot;login&quot;, salt=&quot;SSS&quot;, default=None) == &quot;yes&quot;:
            # 已经登录的用户...
            return func(request, *args, **kwargs)
        else:
            # 没有登录的用户，跳转刚到登录页面
            return redirect(&quot;/login/?next={}&quot;.format(next_url))
    return inner


def login(request):
    if request.method == &quot;POST&quot;:
        username = request.POST.get(&quot;username&quot;)
        passwd = request.POST.get(&quot;password&quot;)
        if username == &quot;xxx&quot; and passwd == &quot;dashabi&quot;:
            next_url = request.GET.get(&quot;next&quot;)
            if next_url and next_url != &quot;/logout/&quot;:
                response = redirect(next_url)
            else:
                response = redirect(&quot;/class_list/&quot;)
            response.set_signed_cookie(&quot;login&quot;, &quot;yes&quot;, salt=&quot;SSS&quot;)
            return response
    return render(request, &quot;login.html&quot;)
</code></pre><h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><h4 id="session的由来"><a href="#session的由来" class="headerlink" title="session的由来"></a>session的由来</h4><p>Cookie虽然在一定程度上解决了“保持状态”的需求，但是由于Cookie本身最大支持4096字节，以及Cookie本身保存在客户端，可能被拦截或窃取，因此就需要有一种新的东西，它能支持更多的字节，并且他保存在服务器，有较高的安全性。这就是Session。</p>
<p>问题来了，基于HTTP协议的无状态特征，服务器根本就不知道访问者是“谁”。那么上述的Cookie就起到桥接的作用。</p>
<p>我们可以给每个客户端的Cookie分配一个唯一的id，这样用户在访问时，通过Cookie，服务器就知道来的人是“谁”。然后我们再根据不同的Cookie的id，在服务器上保存一段时间的私密资料，如“账号密码”等等。</p>
<p>总结而言：Cookie弥补了HTTP无状态的不足，让服务器知道来的人是“谁”；但是Cookie以文本的形式保存在本地，自身安全性较差；所以我们就通过Cookie识别不同的用户，对应的在Session里保存私密的信息以及超过4096字节的文本。</p>
<p>另外，上述所说的Cookie和Session其实是共通性的东西，不限于语言和框架。</p>
<h3 id="Django中Session相关方法"><a href="#Django中Session相关方法" class="headerlink" title="Django中Session相关方法"></a>Django中Session相关方法</h3><pre><code>##### 获取、设置、删除Session中数据
request.session[&apos;k1&apos;]
request.session.get(&apos;k1&apos;,None)
request.session[&apos;k1&apos;] = 123
request.session.setdefault(&apos;k1&apos;,123) # 存在则不设置
del request.session[&apos;k1&apos;]


##### 所有 键、值、键值对
request.session.keys()
request.session.values()
request.session.items()
request.session.iterkeys()
request.session.itervalues()
request.session.iteritems()

##### 会话session的key
request.session.session_key

##### 将所有Session失效日期小于当前日期的数据删除
request.session.clear_expired()

##### 检查会话session的key在数据库中是否存在
request.session.exists(&quot;session_key&quot;)

##### 删除当前会话的所有Session数据
request.session.delete()
　　
##### 删除当前的会话数据并删除会话的Cookie。
request.session.flush() 
​    这用于确保前面的会话数据不可以再次被用户的浏览器访问
​    例如，django.contrib.auth.logout() 函数中就会调用它。

##### 设置会话Session和Cookie的超时时间
request.session.set_expiry(value)
    * 如果value是个整数，session会在些秒数后失效。
        * 如果value是个datatime或timedelta，session就会在这个时间后失效。
        * 如果value是0,用户关闭浏览器session就会失效。
        * 如果value是None,session会依赖全局session失效策略。
</code></pre><h4 id="Session流程解析"><a href="#Session流程解析" class="headerlink" title="Session流程解析"></a>Session流程解析</h4><p><img src="/2018/12/16/Cookie和Session/2.png" alt=""></p>
<h4 id="Session版登陆验证"><a href="#Session版登陆验证" class="headerlink" title="Session版登陆验证"></a>Session版登陆验证</h4><pre><code>from functools import wraps

def check_login(func):
​    @wraps(func)
​    def inner(request, *args, **kwargs):
​        next_url = request.get_full_path()
​        if request.session.get(&quot;user&quot;):
​            return func(request, *args, **kwargs)
​        else:
​            return redirect(&quot;/login/?next={}&quot;.format(next_url))
​    return inner


def login(request):
​    if request.method == &quot;POST&quot;:
​        user = request.POST.get(&quot;user&quot;)
​        pwd = request.POST.get(&quot;pwd&quot;)

        if user == &quot;alex&quot; and pwd == &quot;alex1234&quot;:
            # 设置session
            request.session[&quot;user&quot;] = user
            # 获取跳到登陆页面之前的URL
            next_url = request.GET.get(&quot;next&quot;)
            # 如果有，就跳转回登陆之前的URL
            if next_url:
                return redirect(next_url)
            # 否则默认跳转到index页面
            else:
                return redirect(&quot;/index/&quot;)
    return render(request, &quot;login.html&quot;)


@check_login
def logout(request):
​    # 删除所有当前请求相关的session
​    request.session.delete()
​    return redirect(&quot;/login/&quot;)


@check_login
def index(request):
​    current_user = request.session.get(&quot;user&quot;, None)
​    return render(request, &quot;index.html&quot;, {&quot;user&quot;: current_user})
</code></pre><h4 id="Django中的Session配置"><a href="#Django中的Session配置" class="headerlink" title="Django中的Session配置"></a>Django中的Session配置</h4><p>Django中默认支持Session，其内部提供了5种类型的Session供开发者使用。</p>
<pre><code>1. 数据库Session
  SESSION_ENGINE = &apos;django.contrib.sessions.backends.db&apos;   # 引擎（默认）

2. 缓存Session
  SESSION_ENGINE = &apos;django.contrib.sessions.backends.cache&apos;  # 引擎
  SESSION_CACHE_ALIAS = &apos;default&apos;                            # 使用的缓存别名（默认内存缓存，也可以是memcache），此处别名依赖缓存的设置

3. 文件Session
  SESSION_ENGINE = &apos;django.contrib.sessions.backends.file&apos;    # 引擎
  SESSION_FILE_PATH = None                                    # 缓存文件路径，如果为None，则使用tempfile模块获取一个临时地址tempfile.gettempdir() 

4. 缓存+数据库
  SESSION_ENGINE = &apos;django.contrib.sessions.backends.cached_db&apos;        # 引擎

5. 加密Cookie Session
  SESSION_ENGINE = &apos;django.contrib.sessions.backends.signed_cookies&apos;   # 引擎

其他公用设置项：
SESSION_COOKIE_NAME ＝ &quot;sessionid&quot;                       # Session的cookie保存在浏览器上时的key，即：sessionid＝随机字符串（默认）
SESSION_COOKIE_PATH ＝ &quot;/&quot;                               # Session的cookie保存的路径（默认）
SESSION_COOKIE_DOMAIN = None                             # Session的cookie保存的域名（默认）
SESSION_COOKIE_SECURE = False                            # 是否Https传输cookie（默认）
SESSION_COOKIE_HTTPONLY = True                           # 是否Session的cookie只支持http传输（默认）
SESSION_COOKIE_AGE = 1209600                             # Session的cookie失效日期（2周）（默认）
SESSION_EXPIRE_AT_BROWSER_CLOSE = False                  # 是否关闭浏览器使得Session过期（默认）
SESSION_SAVE_EVERY_REQUEST = False                       # 是否每次请求都保存Session，默认修改之后才保存（默认）

Django中Session相关设置
</code></pre>
            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2018/12/16/Cookie和Session/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://yoursite.com/2018/12/16/Cookie和Session/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
